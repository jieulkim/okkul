stages:
  - test
  - build
  - deploy

variables:
  # Gradle ìºì‹œë¥¼ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ë‚´ë¶€ë¡œ ì§€ì • (GitLab ìºì‹œ ì—°ë™ìš©)
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/be/.gradle"

# --------------------------------------------------------------------------
# [Global Cache] - Gradle ì˜ì¡´ì„± ì¬ì‚¬ìš©ìœ¼ë¡œ ì†ë„ ì—…!
# --------------------------------------------------------------------------
cache:
  key:
    files:
      - be/build.gradle
      - be/settings.gradle
  paths:
    - be/.gradle/wrapper
    - be/.gradle/caches
  policy: pull-push

# --------------------------------------------------------------------------
# 1. TEST ìŠ¤í…Œì´ì§€
# --------------------------------------------------------------------------

# [BE í…ŒìŠ¤íŠ¸] - ëª¨ë“  ë¸Œëœì¹˜ì—ì„œ be í´ë” ìˆ˜ì • ì‹œ ì‹¤í–‰
test-be:
  stage: test
  image: eclipse-temurin:21-jdk-alpine
  services:
    - name: postgres:16.11
      alias: postgres-test
    - name: redis:7.2-alpine
      alias: redis-test
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: jdbc:postgresql://postgres-test:5432/test_db
    DATABASE_USERNAME: test_user
    DATABASE_PASSWORD: test_password
    REDIS_HOST: redis-test
    REDIS_PORT: 6379
  tags:
    - aws-ec2
  rules:
    - changes:
        - be/**/*
  before_script:
    - chmod +x be/gradlew
  script:
    - cd be
    - ./gradlew test
  artifacts:
    paths:
      - be/build/
    expire_in: 1 hour

# --------------------------------------------------------------------------
# 2. BUILD ìŠ¤í…Œì´ì§€
# --------------------------------------------------------------------------

# [BE ì´ë¯¸ì§€ ë¹Œë“œ] - íŠ¹ì • 3ê°œ ë¸Œëœì¹˜ + be í´ë” ë³€ê²½ ì‹œ
build-be:
  stage: build
  image: eclipse-temurin:21-jdk-alpine
  needs: ["test-be"] # í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ ì¦‰ì‹œ ì‹œì‘
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - be/**/*
  before_script:
    - apk update
    - apk add --no-cache docker docker-cli-compose
    - chmod +x be/gradlew
  script:
    - echo "Backend ì´ë¯¸ì§€ ë¹Œë“œ(í…ŒìŠ¤íŠ¸ ì œì™¸)..."
    - cd be
    - ./gradlew bootBuildImage --imageName=backend:$CI_COMMIT_REF_SLUG -x test

# [FE ë¹Œë“œ] - Docker í™˜ê²½ì´ë©´ ì¶©ë¶„
build-fe:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - fe/**/* # FE í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "âš›ï¸ Frontend ë¹Œë“œ ì‹œì‘..."
    - cd fe
    - docker build -t frontend:$CI_COMMIT_REF_SLUG .
    - docker build --build-arg PROFILE=$CI_COMMIT_BRANCH -t frontend:$CI_COMMIT_REF_SLUG .

# [AI ë¹Œë“œ] - Python Docker í™˜ê²½
build-ai:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - ai/**/* # ai í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "ğŸ¤– AI Server ë¹Œë“œ ì‹œì‘..."
    # ai í´ë” ì•ˆì— ìˆëŠ” Dockerfileì„ ë³´ê³  ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.
    # ì´ë¯¸ì§€ ì´ë¦„: ë¸Œëœì¹˜ëª… (ì˜ˆ: ai:master, ai:develop)
    - docker build -t ai:$CI_COMMIT_REF_SLUG ./ai

# --------------------------------------------------------------------------
# 3. DEPLOY ìŠ¤í…Œì´ì§€
# --------------------------------------------------------------------------

deploy-all:
  stage: deploy
  # ğŸ‘‡ [ìˆ˜ì • 1] ì—¬ê¸°ë„ 'stable' ëŒ€ì‹  ìµœì‹  ë²„ì „(26-cli)ì„ ì¨ì•¼ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤!
  image: docker:26-cli 
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
  
  before_script:
    # docker-cli-compose ì„¤ì¹˜ (26-cli ì´ë¯¸ì§€ì—ëŠ” ê¸°ë³¸ dockerëŠ” ìˆìœ¼ë¯€ë¡œ í”ŒëŸ¬ê·¸ì¸ë§Œ ì„¤ì¹˜)
    # í˜¹ì‹œ ëª¨ë¥´ë‹ˆ edge ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ëª…ì‹œ (ê°€ì¥ ì•ˆì „)
    - apk update && apk add --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community docker-cli-compose

  script:
    - echo "ğŸš€ ì „ì²´ ì„œë¹„ìŠ¤ ë°°í¬(ì—…ë°ì´íŠ¸) ì‹œì‘..."
    
    # Compose íŒŒì¼ì´ ìˆëŠ” ë£¨íŠ¸ ìœ„ì¹˜ì¸ì§€ í™•ì¸
    - ls -al 
    
    # 1. í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ì— "_env"ë¥¼ ë¶™ì—¬ì„œ íƒ€ê²Ÿ ë³€ìˆ˜ëª…ì„ ë§Œë“­ë‹ˆë‹¤. (ì˜ˆ: master_env)
    - TARGET_VAR_NAME="${CI_COMMIT_BRANCH}_env"

    # 3. [í•µì‹¬] evalì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ ë³€ìˆ˜ ê°’ì„ íŒŒì¼ë¡œ ì €ì¥
    # ì„¤ëª…: \$$TARGET_VAR_NAME ë¶€ë¶„ì´ $master_env ë¡œ ì¹˜í™˜ë˜ê³ , ê·¸ ì•ˆì˜ ê°’ì„ echo í•¨
    - eval "echo \"\$$TARGET_VAR_NAME\"" > .env
    
    # 1. ë°”ë€ ì´ë¯¸ì§€ë§Œ ê°ì§€í•´ì„œ ì¬ì‹œì‘ (ê°€ì¥ ê¶Œì¥)
    - TAG=$CI_COMMIT_REF_SLUG docker compose -p s14p11a108-$CI_COMMIT_REF_SLUG up -d --remove-orphans
    
    # 2. ì°Œêº¼ê¸° ì •ë¦¬
    - docker image prune -f