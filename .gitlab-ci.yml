stages:
  - build
  - deploy

# [BE ë¹Œë“œ] - Java í™˜ê²½ í•„ìš”
deploy-be:
  stage: build
  image: eclipse-temurin:21-jdk-alpine

  services:
    - name: postgres:16.11
      alias: postgres-test
    - name: redis:7.2-alpine
      alias: redis-test

  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: jdbc:postgresql://postgres-test:5432/test_db
    DATABASE_USERNAME: test_user
    DATABASE_PASSWORD: test_password
    REDIS_HOST: redis-test
    REDIS_PORT: 6379

  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - be/**/*

  before_script:
    - apk update
    - apk add --no-cache docker docker-cli-compose
    - chmod +x be/gradlew
  
  script:
    - echo "Backend ì´ë¯¸ì§€ ë¹Œë“œ..."
    - cd be
    - ./gradlew test
    - ./gradlew bootBuildImage --imageName=backend:$CI_COMMIT_REF_SLUG -x test

# [FE ë¹Œë“œ] - Docker í™˜ê²½ì´ë©´ ì¶©ë¶„
build-fe:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - fe/**/* # FE í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "âš›ï¸ Frontend ë¹Œë“œ ì‹œì‘.."
    - cd fe
    # 1. .env íŒŒì¼ ìƒì„±
    - TARGET_VAR_NAME="${CI_COMMIT_BRANCH}_env"
    - eval "echo \"\$$TARGET_VAR_NAME\"" > .env
    # 2. ë¸Œëœì¹˜ì— ë”°ë¼ ë¹Œë“œ ëª¨ë“œ(PROFILE) ê²°ì •
    - |
      if [ "$CI_COMMIT_BRANCH" = "master" ]; then
        BUILD_MODE="production"
      else
        BUILD_MODE="$CI_COMMIT_BRANCH" # develop, cicd ë¸Œëœì¹˜ëŠ” ì´ë¦„ ê·¸ëŒ€ë¡œ ëª¨ë“œë¡œ ì‚¬ìš©
      fi
      echo "ë¹Œë“œ ëª¨ë“œ ê²°ì •: $BUILD_MODE"ã„´
      docker build --build-arg PROFILE=$BUILD_MODE -t frontend:$CI_COMMIT_REF_SLUG .

# [AI ë¹Œë“œ] - Python Docker í™˜ê²½
build-ai:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - ai/**/* # ai í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "ğŸ¤– AI Server ë¹Œë“œ ì‹œì‘..."
    # ai í´ë” ì•ˆì— ìˆëŠ” Dockerfileì„ ë³´ê³  ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.
    # ì´ë¯¸ì§€ ì´ë¦„: ë¸Œëœì¹˜ëª… (ì˜ˆ: ai:master, ai:develop)
    - docker build -t ai:$CI_COMMIT_REF_SLUG ./ai

# --------------------------------------------------------------------------
# 2. í†µí•© ë°°í¬ ìŠ¤í…Œì´ì§€ (í•­ìƒ ì‹¤í–‰)
# --------------------------------------------------------------------------
deploy-all:
  stage: deploy
  # ğŸ‘‡ [ìˆ˜ì • 1] ì—¬ê¸°ë„ 'stable' ëŒ€ì‹  ìµœì‹  ë²„ì „(26-cli)ì„ ì¨ì•¼ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤!
  image: docker:26-cli 
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
  
  before_script:
    # docker-cli-compose ì„¤ì¹˜ (26-cli ì´ë¯¸ì§€ì—ëŠ” ê¸°ë³¸ dockerëŠ” ìˆìœ¼ë¯€ë¡œ í”ŒëŸ¬ê·¸ì¸ë§Œ ì„¤ì¹˜)
    # í˜¹ì‹œ ëª¨ë¥´ë‹ˆ edge ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ëª…ì‹œ (ê°€ì¥ ì•ˆì „)
    - apk update && apk add --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community docker-cli-compose

  script:
    - echo "ğŸš€ ì „ì²´ ì„œë¹„ìŠ¤ ë°°í¬(ì—…ë°ì´íŠ¸) ì‹œì‘..."
    
    # Compose íŒŒì¼ì´ ìˆëŠ” ë£¨íŠ¸ ìœ„ì¹˜ì¸ì§€ í™•ì¸
    - ls -al 
    
    # 1. í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ì— "_env"ë¥¼ ë¶™ì—¬ì„œ íƒ€ê²Ÿ ë³€ìˆ˜ëª…ì„ ë§Œë“­ë‹ˆë‹¤. (ì˜ˆ: master_env)
    - TARGET_VAR_NAME="${CI_COMMIT_BRANCH}_env"

    # 3. [í•µì‹¬] evalì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ ë³€ìˆ˜ ê°’ì„ íŒŒì¼ë¡œ ì €ì¥
    # ì„¤ëª…: \$$TARGET_VAR_NAME ë¶€ë¶„ì´ $master_env ë¡œ ì¹˜í™˜ë˜ê³ , ê·¸ ì•ˆì˜ ê°’ì„ echo í•¨
    - eval "echo \"\$$TARGET_VAR_NAME\"" > .env
    
    # 1. ë°”ë€ ì´ë¯¸ì§€ë§Œ ê°ì§€í•´ì„œ ì¬ì‹œì‘ (ê°€ì¥ ê¶Œì¥)
    - TAG=$CI_COMMIT_REF_SLUG docker compose -p s14p11a108-$CI_COMMIT_REF_SLUG up -d --remove-orphans
    
    # 2. ì°Œêº¼ê¸° ì •ë¦¬
    - docker image prune -f