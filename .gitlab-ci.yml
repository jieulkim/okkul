stages:
  - build
  - deploy

# [BE ë¹Œë“œ] - Java í™˜ê²½ í•„ìš”
deploy-be:
  stage: build
  image: eclipse-temurin:21-jdk-alpine

  tags:
    - aws-ec2
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - be/**/*

  before_script:
    - apk update
    - apk add --no-cache docker docker-cli-compose
    - chmod +x be/gradlew
  
  script:
    - echo "Backend ì´ë¯¸ì§€ ë¹Œë“œ..."
    - cd be
    - ./gradlew test
    - ./gradlew bootBuildImage -x test

# [FE ë¹Œë“œ] - Docker í™˜ê²½ì´ë©´ ì¶©ë¶„
build-fe:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - fe/**/* # FE í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "âš›ï¸ Frontend ë¹Œë“œ ì‹œì‘..."
    - cd fe
    - docker build -t frontend:latest .

# --------------------------------------------------------------------------
# 2. í†µí•© ë°°í¬ ìŠ¤í…Œì´ì§€ (í•­ìƒ ì‹¤í–‰)
# --------------------------------------------------------------------------
deploy-all:
  stage: deploy
  image: docker:stable
  tags:
    - aws-ec2
  # ë°°í¬ëŠ” ì–´ëŠ í•˜ë‚˜ë¼ë„ ë¹Œë“œê°€ ëŒì•˜ê±°ë‚˜, ìˆ˜ë™ ì‹¤í–‰ì¼ ë•Œ ëŒì•„ì•¼ í•¨
  # ì‚¬ì‹¤ìƒ ë©”ì¸ ë¸Œëœì¹˜ë©´ ë¬´ì¡°ê±´ ì²´í¬í•˜ëŠ” ê²Œ ì•ˆì „í•¨ (Composeê°€ ì•Œì•„ì„œ íŒë‹¨í•˜ë‹ˆê¹Œ)
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "cicd"'
  before_script:
    - apk update && apk add --no-cache docker-cli-compose
  script:
    - echo "ğŸš€ ì „ì²´ ì„œë¹„ìŠ¤ ë°°í¬(ì—…ë°ì´íŠ¸) ì‹œì‘..."
    
    # docker composeëŠ” ë°”ë€ ì´ë¯¸ì§€ë§Œ ê°ì§€í•´ì„œ í•´ë‹¹ ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
    # (ì£¼ì˜: --force-recreateë¥¼ ì“°ë©´ ë³€ê²½ ì—†ì–´ë„ ê°•ì œë¡œ ë‹¤ ê»ë‹¤ ì¼­ë‹ˆë‹¤. ìƒí™© ë´ì„œ ë¹¼ë„ ë©ë‹ˆë‹¤.)
    - docker compose up -d --remove-orphans
    
    # ì°Œêº¼ê¸° ì´ë¯¸ì§€ ì •ë¦¬
    - docker image prune -f