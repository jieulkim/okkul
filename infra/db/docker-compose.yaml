services:
  postgres:
    image: postgres:16.11
    container_name: my-postgres-server
    restart: always
    ports:
      # 핵심: 호스트의 로컬 루프백(127.0.0.1) 주소에만 포트를 바인딩합니다.
      # 외부 IP에서는 이 포트가 열려있지 않은 것으로 보입니다.
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_USER: root_admin        # 최상위 관리자 계정 (운영 시 변경 권장)
      POSTGRES_PASSWORD: root_password # 관리자 비밀번호 (운영 시 변경 필수)
      POSTGRES_DB: main_db             # 기본 생성될 데이터베이스 이름
    volumes:
      # 1. 데이터 영구 저장 (컨테이너가 삭제되어도 데이터 보존)
      - ./pg_data:/var/lib/postgresql/data
      # 2. 초기 세팅 스크립트 자동 실행 (스키마/유저 자동 생성용)
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - server-tools_default

  redis:
    image: redis:7.2-alpine
    container_name: my-redis-server
    restart: always
    ports:
      - "127.0.0.1:6379:6379"
    # 그냥 '1234'로 설정하세요. 타이핑하기 쉽게!
    command: redis-server --requirepass "1234"
    volumes:
      - ./redis_data:/data
    networks:
      - server-tools_default

  
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    restart: always
    environment:
      # 포스트그레 연결 정보 (서비스 이름 'postgres' 사용)
      DATA_SOURCE_NAME: "postgresql://root_admin:root_password@postgres:5432/main_db?sslmode=disable"
    networks:
      - server-tools_default


  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    restart: always
    environment:
      # 레디스 주소 및 비밀번호 설정
      REDIS_ADDR: "redis://redis:6379"
      REDIS_PASSWORD: "1234"
    networks:
      - server-tools_default

volumes:
  pg_data:

networks:
  server-tools_default:
    external: true