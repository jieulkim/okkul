stages:
  - build
  - deploy

# [BE ë¹Œë“œ] - Java í™˜ê²½ í•„ìš”
deploy-be:
  stage: build
  image: eclipse-temurin:21-jdk-alpine

  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - be/**/*

  before_script:
    - apk update
    - apk add --no-cache docker docker-cli-compose
    - chmod +x be/gradlew
  
  script:
    - echo "Backend ì´ë¯¸ì§€ ë¹Œë“œ..."
    - cd be
    - ./gradlew test
    - ./gradlew bootBuildImage --imageName=backend:$CI_COMMIT_REF_SLUG -x test

# [FE ë¹Œë“œ] - Docker í™˜ê²½ì´ë©´ ì¶©ë¶„
build-fe:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - fe/**/* # FE í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "âš›ï¸ Frontend ë¹Œë“œ ì‹œì‘..."
    - cd fe
    - docker build -t frontend:$CI_COMMIT_REF_SLUG .

# [AI ë¹Œë“œ] - Python Docker í™˜ê²½
build-ai:
  stage: build
  image: docker:26-cli
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
      changes:
        - ai/**/* # ai í´ë”ê°€ ë³€í–ˆì„ ë•Œë§Œ ì‹¤í–‰
  script:
    - echo "ğŸ¤– AI Server ë¹Œë“œ ì‹œì‘..."
    # ai í´ë” ì•ˆì— ìˆëŠ” Dockerfileì„ ë³´ê³  ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.
    # ì´ë¯¸ì§€ ì´ë¦„: ë¸Œëœì¹˜ëª… (ì˜ˆ: ai:master, ai:develop)
    - docker build -t ai:$CI_COMMIT_REF_SLUG ./ai

# --------------------------------------------------------------------------
# 2. í†µí•© ë°°í¬ ìŠ¤í…Œì´ì§€ (í•­ìƒ ì‹¤í–‰)
# --------------------------------------------------------------------------
deploy-all:
  stage: deploy
  # ğŸ‘‡ [ìˆ˜ì • 1] ì—¬ê¸°ë„ 'stable' ëŒ€ì‹  ìµœì‹  ë²„ì „(26-cli)ì„ ì¨ì•¼ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤!
  image: docker:26-cli 
  tags:
    - aws-ec2
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "cicd"'
  
  before_script:
    # docker-cli-compose ì„¤ì¹˜ (26-cli ì´ë¯¸ì§€ì—ëŠ” ê¸°ë³¸ dockerëŠ” ìˆìœ¼ë¯€ë¡œ í”ŒëŸ¬ê·¸ì¸ë§Œ ì„¤ì¹˜)
    # í˜¹ì‹œ ëª¨ë¥´ë‹ˆ edge ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ëª…ì‹œ (ê°€ì¥ ì•ˆì „)
    - apk update && apk add --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community docker-cli-compose

  script:
    - echo "ğŸš€ ì „ì²´ ì„œë¹„ìŠ¤ ë°°í¬(ì—…ë°ì´íŠ¸) ì‹œì‘..."
    
    # Compose íŒŒì¼ì´ ìˆëŠ” ë£¨íŠ¸ ìœ„ì¹˜ì¸ì§€ í™•ì¸
    - ls -al 
    
    # 1. ë°”ë€ ì´ë¯¸ì§€ë§Œ ê°ì§€í•´ì„œ ì¬ì‹œì‘ (ê°€ì¥ ê¶Œì¥)
    - TAG=$CI_COMMIT_REF_SLUG docker compose -p s14p11a108-$CI_COMMIT_REF_SLUG up -d --remove-orphans
    
    # 2. ì°Œêº¼ê¸° ì •ë¦¬
    - docker image prune -f